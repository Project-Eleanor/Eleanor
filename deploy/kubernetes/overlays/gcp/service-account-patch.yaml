# Patch deployments to use Workload Identity service accounts
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: backend
  namespace: eleanor
spec:
  template:
    spec:
      serviceAccountName: eleanor-backend
      # Node selector for Workload Identity enabled nodes
      nodeSelector:
        iam.gke.io/gke-metadata-server-enabled: "true"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: celery-worker
  namespace: eleanor
spec:
  template:
    spec:
      serviceAccountName: eleanor-celery
      nodeSelector:
        iam.gke.io/gke-metadata-server-enabled: "true"
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: celery-beat
  namespace: eleanor
spec:
  template:
    spec:
      serviceAccountName: eleanor-celery
      nodeSelector:
        iam.gke.io/gke-metadata-server-enabled: "true"
---
# Patch services to use BackendConfig
apiVersion: v1
kind: Service
metadata:
  name: backend
  namespace: eleanor
  annotations:
    cloud.google.com/backend-config: '{"default": "eleanor-backend-config"}'
    cloud.google.com/neg: '{"ingress": true}'
---
apiVersion: v1
kind: Service
metadata:
  name: frontend
  namespace: eleanor
  annotations:
    cloud.google.com/neg: '{"ingress": true}'
