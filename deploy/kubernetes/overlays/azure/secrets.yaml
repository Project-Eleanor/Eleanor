---
# Secret Provider Class for Azure Key Vault CSI Driver
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: eleanor-keyvault-secrets
  namespace: eleanor
spec:
  provider: azure
  parameters:
    usePodIdentity: "false"
    useVMManagedIdentity: "false"
    clientID: ${EXTERNAL_SECRETS_CLIENT_ID}
    keyvaultName: ${KEY_VAULT_NAME}
    cloudName: AzurePublicCloud
    objects: |
      array:
        - |
          objectName: eleanor-database-url
          objectType: secret
          objectAlias: DATABASE_URL
        - |
          objectName: eleanor-secret-key
          objectType: secret
          objectAlias: SECRET_KEY
        - |
          objectName: eleanor-jwt-secret
          objectType: secret
          objectAlias: JWT_SECRET
        - |
          objectName: eleanor-redis-url
          objectType: secret
          objectAlias: REDIS_URL
        - |
          objectName: eleanor-elasticsearch-url
          objectType: secret
          objectAlias: ELASTICSEARCH_URL
        - |
          objectName: eleanor-velociraptor-api-key
          objectType: secret
          objectAlias: VELOCIRAPTOR_API_KEY
        - |
          objectName: eleanor-iris-api-key
          objectType: secret
          objectAlias: IRIS_API_KEY
        - |
          objectName: eleanor-opencti-api-key
          objectType: secret
          objectAlias: OPENCTI_API_KEY
        - |
          objectName: eleanor-storage-connection-string
          objectType: secret
          objectAlias: STORAGE_CONNECTION_STRING
    tenantId: ${AZURE_TENANT_ID}
  secretObjects:
    - secretName: eleanor-secrets
      type: Opaque
      data:
        - objectName: DATABASE_URL
          key: DATABASE_URL
        - objectName: SECRET_KEY
          key: SECRET_KEY
        - objectName: JWT_SECRET
          key: JWT_SECRET
        - objectName: REDIS_URL
          key: REDIS_URL
        - objectName: ELASTICSEARCH_URL
          key: ELASTICSEARCH_URL
        - objectName: VELOCIRAPTOR_API_KEY
          key: VELOCIRAPTOR_API_KEY
        - objectName: IRIS_API_KEY
          key: IRIS_API_KEY
        - objectName: OPENCTI_API_KEY
          key: OPENCTI_API_KEY
        - objectName: STORAGE_CONNECTION_STRING
          key: STORAGE_CONNECTION_STRING

---
# Alternative: External Secrets Operator with Azure Key Vault
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: azure-key-vault
  namespace: eleanor
spec:
  provider:
    azurekv:
      authType: WorkloadIdentity
      vaultUrl: https://${KEY_VAULT_NAME}.vault.azure.net
      serviceAccountRef:
        name: external-secrets

---
# Eleanor Secrets from Azure Key Vault
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: eleanor-external-secrets
  namespace: eleanor
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: azure-key-vault
    kind: SecretStore
  target:
    name: eleanor-secrets-eso
    creationPolicy: Owner
  data:
    - secretKey: DATABASE_URL
      remoteRef:
        key: eleanor-database-url
    - secretKey: SECRET_KEY
      remoteRef:
        key: eleanor-secret-key
    - secretKey: JWT_SECRET
      remoteRef:
        key: eleanor-jwt-secret
    - secretKey: REDIS_URL
      remoteRef:
        key: eleanor-redis-url
    - secretKey: ELASTICSEARCH_URL
      remoteRef:
        key: eleanor-elasticsearch-url
    - secretKey: STORAGE_CONNECTION_STRING
      remoteRef:
        key: eleanor-storage-connection-string
