apiVersion: karpenter.sh/v1beta1
kind: NodePool
metadata:
  name: eleanor-general
  labels:
    app.kubernetes.io/name: eleanor
    app.kubernetes.io/component: autoscaling
    app.kubernetes.io/part-of: eleanor-dfir
spec:
  template:
    metadata:
      labels:
        eleanor.io/node-type: general
        eleanor.io/workload: mixed
    spec:
      nodeClassRef:
        apiVersion: karpenter.k8s.aws/v1beta1
        kind: EC2NodeClass
        name: eleanor-general
      requirements:
        - key: kubernetes.io/arch
          operator: In
          values:
            - amd64
        - key: kubernetes.io/os
          operator: In
          values:
            - linux
        - key: karpenter.sh/capacity-type
          operator: In
          values:
            - spot
            - on-demand
        - key: karpenter.k8s.aws/instance-category
          operator: In
          values:
            - m  # General purpose
            - c  # Compute optimized
        - key: karpenter.k8s.aws/instance-family
          operator: In
          values:
            - m6i
            - m6a
            - m7i
            - c6i
            - c6a
        - key: karpenter.k8s.aws/instance-size
          operator: In
          values:
            - large
            - xlarge
            - 2xlarge
            - 4xlarge
      taints: []
  limits:
    cpu: 100
    memory: 400Gi
  disruption:
    consolidationPolicy: WhenUnderutilized
    consolidateAfter: 30s
    budgets:
      - nodes: "10%"
  weight: 100
---
apiVersion: karpenter.sh/v1beta1
kind: NodePool
metadata:
  name: eleanor-memory-optimized
  labels:
    app.kubernetes.io/name: eleanor
    app.kubernetes.io/component: autoscaling
    app.kubernetes.io/part-of: eleanor-dfir
spec:
  template:
    metadata:
      labels:
        eleanor.io/node-type: memory-optimized
        eleanor.io/workload: elasticsearch
    spec:
      nodeClassRef:
        apiVersion: karpenter.k8s.aws/v1beta1
        kind: EC2NodeClass
        name: eleanor-memory-optimized
      requirements:
        - key: kubernetes.io/arch
          operator: In
          values:
            - amd64
        - key: kubernetes.io/os
          operator: In
          values:
            - linux
        - key: karpenter.sh/capacity-type
          operator: In
          values:
            - on-demand  # On-demand only for stateful workloads
        - key: karpenter.k8s.aws/instance-category
          operator: In
          values:
            - r  # Memory optimized
        - key: karpenter.k8s.aws/instance-family
          operator: In
          values:
            - r6i
            - r6a
            - r7i
        - key: karpenter.k8s.aws/instance-size
          operator: In
          values:
            - xlarge
            - 2xlarge
            - 4xlarge
            - 8xlarge
      taints:
        - key: eleanor.io/workload
          value: memory-intensive
          effect: NoSchedule
  limits:
    cpu: 64
    memory: 512Gi
  disruption:
    consolidationPolicy: WhenEmpty
    consolidateAfter: 5m
    budgets:
      - nodes: "1"
  weight: 50
---
apiVersion: karpenter.sh/v1beta1
kind: NodePool
metadata:
  name: eleanor-spot-burst
  labels:
    app.kubernetes.io/name: eleanor
    app.kubernetes.io/component: autoscaling
    app.kubernetes.io/part-of: eleanor-dfir
spec:
  template:
    metadata:
      labels:
        eleanor.io/node-type: spot-burst
        eleanor.io/workload: celery-workers
    spec:
      nodeClassRef:
        apiVersion: karpenter.k8s.aws/v1beta1
        kind: EC2NodeClass
        name: eleanor-general
      requirements:
        - key: kubernetes.io/arch
          operator: In
          values:
            - amd64
        - key: kubernetes.io/os
          operator: In
          values:
            - linux
        - key: karpenter.sh/capacity-type
          operator: In
          values:
            - spot  # Spot only for burst capacity
        - key: karpenter.k8s.aws/instance-category
          operator: In
          values:
            - m
            - c
            - r
        - key: karpenter.k8s.aws/instance-size
          operator: In
          values:
            - large
            - xlarge
            - 2xlarge
      taints:
        - key: eleanor.io/workload
          value: spot-burst
          effect: NoSchedule
  limits:
    cpu: 200
    memory: 800Gi
  disruption:
    consolidationPolicy: WhenUnderutilized
    consolidateAfter: 10s
    budgets:
      - nodes: "20%"
  weight: 10
