#cloud-config
autoinstall:
  version: 1

  locale: en_US.UTF-8
  keyboard:
    layout: us

  network:
    version: 2
    ethernets:
      id0:
        match:
          name: "e*"
        dhcp4: true

  storage:
    layout:
      name: lvm
      sizing-policy: all

  identity:
    hostname: eleanor
    username: eleanor
    password: "$6$nw872uj.8BV2nUDv$TzhUnn5U9DGoIGBpAp.ibnK5PCVXKc0JM1dcENtw1r/uXYx6oOBvOZdNbz3l4SJw3wFrVE/ZSc1TUdgv1ygES1"

  ssh:
    install-server: true
    allow-pw: true

  packages:
    - openssh-server
    - curl
    - wget
    - git
    - vim
    - htop
    - jq
    - unzip
    - ca-certificates
    - gnupg
    - lsb-release
    - apt-transport-https
    - software-properties-common
    - python3
    - python3-pip
    - python3-venv
    - net-tools
    - nfs-common
    - open-vm-tools

  late-commands:
    # Enable services
    - curtin in-target --target=/target -- systemctl enable ssh
    - curtin in-target --target=/target -- systemctl enable open-vm-tools
    # Set password using chpasswd (backup for identity password)
    - echo 'eleanor:eleanor-setup' | curtin in-target --target=/target -- chpasswd
    # Configure SSH for password and key auth
    - sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication yes/' /target/etc/ssh/sshd_config
    - sed -i 's/^#*PubkeyAuthentication.*/PubkeyAuthentication yes/' /target/etc/ssh/sshd_config
    - sed -i 's/^KbdInteractiveAuthentication.*/KbdInteractiveAuthentication yes/' /target/etc/ssh/sshd_config
    # Set up SSH keys for eleanor user
    - curtin in-target --target=/target -- mkdir -p /home/eleanor/.ssh
    - echo 'ssh-ed25519 AAAAC3NzaC1lZDI1NTE5AAAAINOdl3Dnl9q8iM8z9P7HQQnGwEzUhYsWNhHtl7oUMKyK packer-build' > /target/home/eleanor/.ssh/authorized_keys
    - curtin in-target --target=/target -- chmod 700 /home/eleanor/.ssh
    - curtin in-target --target=/target -- chmod 600 /home/eleanor/.ssh/authorized_keys
    - curtin in-target --target=/target -- chown -R eleanor:eleanor /home/eleanor/.ssh
    # Create Eleanor directories
    - curtin in-target --target=/target -- mkdir -p /opt/eleanor /opt/eleanor-setup /var/lib/eleanor
    - curtin in-target --target=/target -- chown -R 1000:1000 /opt/eleanor /opt/eleanor-setup /var/lib/eleanor
