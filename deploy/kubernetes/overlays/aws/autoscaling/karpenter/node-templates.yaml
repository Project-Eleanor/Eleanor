apiVersion: karpenter.k8s.aws/v1beta1
kind: EC2NodeClass
metadata:
  name: eleanor-general
  labels:
    app.kubernetes.io/name: eleanor
    app.kubernetes.io/component: autoscaling
    app.kubernetes.io/part-of: eleanor-dfir
spec:
  amiFamily: AL2023
  role: "KarpenterNodeRole-${CLUSTER_NAME}"
  subnetSelectorTerms:
    - tags:
        karpenter.sh/discovery: "${CLUSTER_NAME}"
        kubernetes.io/role/internal-elb: "1"
  securityGroupSelectorTerms:
    - tags:
        karpenter.sh/discovery: "${CLUSTER_NAME}"
  instanceStorePolicy: RAID0
  blockDeviceMappings:
    - deviceName: /dev/xvda
      ebs:
        volumeSize: 100Gi
        volumeType: gp3
        iops: 3000
        throughput: 125
        encrypted: true
        deleteOnTermination: true
    - deviceName: /dev/xvdb
      ebs:
        volumeSize: 200Gi
        volumeType: gp3
        iops: 6000
        throughput: 250
        encrypted: true
        deleteOnTermination: true
  userData: |
    #!/bin/bash
    set -e

    # Configure container runtime for DFIR workloads
    cat <<'EOF' >> /etc/containerd/config.toml
    [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
      SystemdCgroup = true
    EOF

    # Increase file descriptor limits for Elasticsearch
    cat <<'EOF' >> /etc/security/limits.conf
    * soft nofile 65535
    * hard nofile 65535
    * soft nproc 65535
    * hard nproc 65535
    EOF

    # Kernel parameters for DFIR workloads
    cat <<'EOF' >> /etc/sysctl.d/99-eleanor.conf
    vm.max_map_count=262144
    vm.swappiness=1
    net.core.somaxconn=65535
    net.ipv4.tcp_max_syn_backlog=65535
    EOF
    sysctl --system

    # Mount ephemeral storage if available
    if [ -b /dev/nvme1n1 ]; then
      mkfs.xfs /dev/nvme1n1
      mkdir -p /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs
      mount /dev/nvme1n1 /var/lib/containerd/io.containerd.snapshotter.v1.overlayfs
    fi
  tags:
    Name: "eleanor-general-${CLUSTER_NAME}"
    Environment: production
    Application: eleanor-dfir
    ManagedBy: karpenter
  metadataOptions:
    httpEndpoint: enabled
    httpProtocolIPv6: disabled
    httpPutResponseHopLimit: 2
    httpTokens: required  # IMDSv2 required
---
apiVersion: karpenter.k8s.aws/v1beta1
kind: EC2NodeClass
metadata:
  name: eleanor-memory-optimized
  labels:
    app.kubernetes.io/name: eleanor
    app.kubernetes.io/component: autoscaling
    app.kubernetes.io/part-of: eleanor-dfir
spec:
  amiFamily: AL2023
  role: "KarpenterNodeRole-${CLUSTER_NAME}"
  subnetSelectorTerms:
    - tags:
        karpenter.sh/discovery: "${CLUSTER_NAME}"
        kubernetes.io/role/internal-elb: "1"
  securityGroupSelectorTerms:
    - tags:
        karpenter.sh/discovery: "${CLUSTER_NAME}"
  instanceStorePolicy: RAID0
  blockDeviceMappings:
    - deviceName: /dev/xvda
      ebs:
        volumeSize: 100Gi
        volumeType: gp3
        iops: 3000
        throughput: 125
        encrypted: true
        deleteOnTermination: true
    - deviceName: /dev/xvdb
      ebs:
        volumeSize: 500Gi
        volumeType: gp3
        iops: 10000
        throughput: 500
        encrypted: true
        deleteOnTermination: true
  userData: |
    #!/bin/bash
    set -e

    # Configure for memory-intensive workloads (Elasticsearch)
    cat <<'EOF' >> /etc/containerd/config.toml
    [plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc.options]
      SystemdCgroup = true
    EOF

    # Elasticsearch requires higher limits
    cat <<'EOF' >> /etc/security/limits.conf
    * soft nofile 131072
    * hard nofile 131072
    * soft nproc 131072
    * hard nproc 131072
    * soft memlock unlimited
    * hard memlock unlimited
    EOF

    # Kernel parameters optimized for Elasticsearch
    cat <<'EOF' >> /etc/sysctl.d/99-elasticsearch.conf
    vm.max_map_count=262144
    vm.swappiness=1
    vm.dirty_ratio=40
    vm.dirty_background_ratio=10
    net.core.somaxconn=65535
    net.ipv4.tcp_max_syn_backlog=65535
    net.core.netdev_max_backlog=65535
    EOF
    sysctl --system

    # Disable transparent hugepages (recommended for Elasticsearch)
    echo never > /sys/kernel/mm/transparent_hugepage/enabled
    echo never > /sys/kernel/mm/transparent_hugepage/defrag

    # Mount data volume for Elasticsearch
    mkfs.xfs /dev/xvdb
    mkdir -p /data/elasticsearch
    mount /dev/xvdb /data/elasticsearch
    chown 1000:1000 /data/elasticsearch
  tags:
    Name: "eleanor-memory-optimized-${CLUSTER_NAME}"
    Environment: production
    Application: eleanor-dfir
    WorkloadType: elasticsearch
    ManagedBy: karpenter
  metadataOptions:
    httpEndpoint: enabled
    httpProtocolIPv6: disabled
    httpPutResponseHopLimit: 2
    httpTokens: required
