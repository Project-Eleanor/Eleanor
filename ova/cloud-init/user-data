#cloud-config
autoinstall:
  version: 1

  # Locale and keyboard
  locale: en_US.UTF-8
  keyboard:
    layout: us

  # Network configuration (DHCP by default)
  network:
    version: 2
    ethernets:
      ens32:
        dhcp4: true
        dhcp-identifier: mac
      enp0s3:
        dhcp4: true
        dhcp-identifier: mac

  # Storage configuration
  storage:
    layout:
      name: lvm
      sizing-policy: all

  # User configuration
  identity:
    hostname: eleanor
    username: eleanor
    # Password: eleanor-setup (to be changed during setup wizard)
    password: "$6$rounds=4096$random.salt$xH7QI.xF4EwzS9EFwzj3v3Z3nQ8K9Y3m9W8X1V2U3T4R5E6D7C8B9A0z1x2c3v4b5n6m7"

  # SSH configuration
  ssh:
    install-server: true
    allow-pw: true

  # Package selection
  packages:
    - openssh-server
    - curl
    - wget
    - git
    - vim
    - htop
    - jq
    - unzip
    - ca-certificates
    - gnupg
    - lsb-release
    - apt-transport-https
    - software-properties-common
    - python3
    - python3-pip
    - python3-venv
    - net-tools
    - nfs-common
    - open-vm-tools

  # Late commands (run after installation)
  late-commands:
    - curtin in-target --target=/target -- systemctl enable ssh
    - curtin in-target --target=/target -- systemctl enable open-vm-tools
    # Allow password authentication temporarily for provisioning
    - sed -i 's/^#*PasswordAuthentication.*/PasswordAuthentication yes/' /target/etc/ssh/sshd_config
    # Create Eleanor directories
    - curtin in-target --target=/target -- mkdir -p /opt/eleanor
    - curtin in-target --target=/target -- mkdir -p /opt/eleanor-setup
    - curtin in-target --target=/target -- mkdir -p /var/lib/eleanor
    - curtin in-target --target=/target -- chown -R 1000:1000 /opt/eleanor /opt/eleanor-setup /var/lib/eleanor
    # Enable lingering for eleanor user (for user services)
    - curtin in-target --target=/target -- loginctl enable-linger eleanor || true

  # User data (first boot configuration)
  user-data:
    disable_root: true
    timezone: UTC
    package_update: true
    package_upgrade: true
