---
# External Secrets Operator - SecretStore for GCP Secret Manager
apiVersion: external-secrets.io/v1beta1
kind: SecretStore
metadata:
  name: gcp-secret-manager
  namespace: eleanor
spec:
  provider:
    gcpsm:
      auth:
        workloadIdentity:
          clusterLocation: ${CLUSTER_LOCATION}
          clusterName: ${CLUSTER_NAME}
          clusterProjectID: ${PROJECT_ID}
          serviceAccountRef:
            name: external-secrets
      projectID: ${PROJECT_ID}

---
# Eleanor Secrets from GCP Secret Manager
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: eleanor-secrets
  namespace: eleanor
spec:
  refreshInterval: 1h
  secretStoreRef:
    name: gcp-secret-manager
    kind: SecretStore
  target:
    name: eleanor-secrets
    creationPolicy: Owner
  data:
    # Database credentials
    - secretKey: DATABASE_URL
      remoteRef:
        key: eleanor-database-url
        version: latest
    # Secret key
    - secretKey: SECRET_KEY
      remoteRef:
        key: eleanor-secret-key
        version: latest
    # JWT secret
    - secretKey: JWT_SECRET
      remoteRef:
        key: eleanor-jwt-secret
        version: latest
    # Redis URL
    - secretKey: REDIS_URL
      remoteRef:
        key: eleanor-redis-url
        version: latest
    # Elasticsearch URL
    - secretKey: ELASTICSEARCH_URL
      remoteRef:
        key: eleanor-elasticsearch-url
        version: latest
    # Integration credentials
    - secretKey: VELOCIRAPTOR_API_KEY
      remoteRef:
        key: eleanor-velociraptor-api-key
        version: latest
    - secretKey: IRIS_API_KEY
      remoteRef:
        key: eleanor-iris-api-key
        version: latest
    - secretKey: OPENCTI_API_KEY
      remoteRef:
        key: eleanor-opencti-api-key
        version: latest
    # GCS storage credentials (service account key path)
    - secretKey: STORAGE_ACCESS_KEY
      remoteRef:
        key: eleanor-storage-credentials
        version: latest

---
# Alternative: GCP Config Connector for managing secrets directly
# Requires Config Connector to be installed on the cluster
# apiVersion: secretmanager.cnrm.cloud.google.com/v1beta1
# kind: SecretManagerSecret
# metadata:
#   name: eleanor-database-url
#   namespace: eleanor
# spec:
#   projectRef:
#     external: ${PROJECT_ID}
#   replication:
#     automatic: true
